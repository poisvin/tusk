<%= turbo_frame_tag "modal-content" do %>
  <div class="bg-background-dark border border-slate-800 rounded-t-2xl sm:rounded-2xl overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-800">
      <button
        type="button"
        class="text-slate-400 hover:text-white"
        data-action="modal#close"
      >
        Cancel
      </button>
      <h2 class="text-white font-semibold">
        <%= @task.new_record? ? 'New Task' : 'Edit Task' %>
      </h2>
      <button
        type="submit"
        form="task-form"
        class="text-primary font-semibold hover:text-blue-400"
      >
        Save
      </button>
    </div>

    <!-- Form -->
    <%= form_with model: @task, id: "task-form", class: "p-4 overflow-y-auto max-h-[calc(90vh-60px)]", data: { turbo_frame: "_top", controller: "task-form" } do |f| %>
      <!-- Title -->
      <div class="mb-4">
        <%= f.text_field :title,
            placeholder: "Task title",
            class: "w-full bg-slate-800/50 border #{@task.errors[:title].any? ? 'border-red-500' : 'border-slate-700'} rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-primary" %>
        <% if @task.errors[:title].any? %>
          <p class="text-red-500 text-sm mt-1"><%= @task.errors[:title].first %></p>
        <% end %>
      </div>

      <!-- Description -->
      <div class="mb-4">
        <label class="text-slate-400 text-sm mb-2 block">Description (optional)</label>
        <%= f.text_area :description,
            rows: 3,
            class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-primary resize-none" %>
      </div>

      <!-- Date -->
      <div class="mb-4">
        <label class="text-slate-400 text-sm mb-2 block">Date</label>
        <%= f.date_field :scheduled_date,
            class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" %>
      </div>

      <!-- Time Range -->
      <div class="mb-4 grid grid-cols-2 gap-3">
        <div>
          <label class="text-slate-400 text-sm mb-2 block">Start Time</label>
          <%= f.time_field :start_time,
              value: @task.start_time&.strftime('%H:%M'),
              class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" %>
        </div>
        <div>
          <label class="text-slate-400 text-sm mb-2 block">End Time</label>
          <%= f.time_field :end_time,
              value: @task.end_time&.strftime('%H:%M'),
              class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary" %>
        </div>
      </div>

      <!-- Category -->
      <div class="mb-4">
        <label class="text-slate-400 text-sm mb-2 block">Category</label>
        <div class="flex gap-2" data-controller="button-group" data-button-group-field-value="task_category">
          <% Task.categories.keys.each do |cat| %>
            <button
              type="button"
              class="flex-1 py-2 px-4 rounded-lg border transition-all <%= @task.category == cat ? 'bg-primary/20 border-primary text-primary' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600' %>"
              data-action="button-group#select"
              data-value="<%= cat %>"
            >
              <%= cat.humanize %>
            </button>
          <% end %>
          <%= f.hidden_field :category, data: { button_group_target: "field" } %>
        </div>
      </div>

      <!-- Priority -->
      <div class="mb-4">
        <label class="text-slate-400 text-sm mb-2 block">Priority</label>
        <div class="flex gap-2" data-controller="button-group" data-button-group-field-value="task_priority">
          <% priority_colors = { 'low' => 'text-slate-400', 'medium' => 'text-yellow-500', 'high' => 'text-red-500' } %>
          <% Task.priorities.keys.each do |p| %>
            <button
              type="button"
              class="flex-1 py-2 px-4 rounded-lg border transition-all <%= @task.priority == p ? "bg-slate-800 border-slate-600 #{priority_colors[p]}" : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600' %>"
              data-action="button-group#select"
              data-value="<%= p %>"
            >
              <%= p.humanize %>
            </button>
          <% end %>
          <%= f.hidden_field :priority, data: { button_group_target: "field" } %>
        </div>
      </div>

      <!-- Status (only when editing) -->
      <% unless @task.new_record? %>
        <div class="mb-4">
          <label class="text-slate-400 text-sm mb-2 block">Status</label>
          <div class="relative">
            <%= f.select :status,
                Task.statuses.keys.map { |s| [s.humanize, s] },
                {},
                class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary appearance-none cursor-pointer" %>
            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
              expand_more
            </span>
          </div>
        </div>
      <% end %>

      <!-- Recurrence -->
      <div class="mb-4">
        <label class="text-slate-400 text-sm mb-2 block">Repeat</label>
        <div class="relative">
          <%= f.select :recurrence,
              Task.recurrences.keys.map { |r| [r.humanize, r] },
              {},
              class: "w-full bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary appearance-none cursor-pointer",
              data: { action: "change->task-form#toggleWeeklyDays", task_form_target: "recurrence" } %>
          <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">
            expand_more
          </span>
        </div>
      </div>

      <!-- Weekly Days (shown only when weekly is selected) -->
      <div class="mb-4 <%= 'hidden' unless @task.recurrence == 'weekly' %>" data-task-form-target="weeklyDays">
        <label class="text-slate-400 text-sm mb-2 block">On which days?</label>
        <div class="flex gap-1">
          <% %w[sunday monday tuesday wednesday thursday friday saturday].each do |day| %>
            <label class="flex-1">
              <%= f.check_box :weekly_days,
                  { multiple: true, checked: @task.weekly_days&.include?(day), class: "hidden peer" },
                  day, nil %>
              <span class="block py-2 px-1 rounded-lg border text-xs font-medium text-center transition-all cursor-pointer peer-checked:bg-primary/20 peer-checked:border-primary peer-checked:text-primary bg-slate-800/50 border-slate-700 text-slate-400 hover:border-slate-600">
                <%= day[0..2].capitalize %>
              </span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Tags -->
      <% if @tags.any? %>
        <div class="mb-4">
          <label class="text-slate-400 text-sm mb-2 block">Tags</label>
          <div class="flex flex-wrap gap-2">
            <% @tags.each do |tag| %>
              <label class="cursor-pointer">
                <%= f.check_box :tag_ids,
                    { multiple: true, checked: @task.tag_ids.include?(tag.id), class: "hidden peer" },
                    tag.id, nil %>
                <span
                  class="px-3 py-1 rounded-full text-sm transition-all peer-checked:bg-primary peer-checked:text-white bg-slate-800 text-slate-400 hover:bg-slate-700"
                  <%= "style='background-color: #{tag.color}'" if @task.tag_ids.include?(tag.id) && tag.color.present? %>
                >
                  <%= tag.name %>
                </span>
              </label>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Reminder -->
      <div class="mb-4 flex items-center justify-between">
        <label class="text-white">Remind me</label>
        <label class="relative inline-flex cursor-pointer">
          <%= f.check_box :remind, class: "sr-only peer" %>
          <div class="w-12 h-6 rounded-full transition-all bg-slate-700 peer-checked:bg-primary">
            <div class="w-5 h-5 rounded-full bg-white shadow transform transition-transform translate-x-0.5 translate-y-0.5 peer-checked:translate-x-6"></div>
          </div>
        </label>
      </div>

      <!-- Delete Button (only when editing) -->
      <% unless @task.new_record? %>
        <div class="pt-4 border-t border-slate-800">
          <%= button_to task_path(@task),
              method: :delete,
              form: { data: { turbo_confirm: "Are you sure you want to delete this task?" } },
              class: "w-full py-3 rounded-lg border border-red-500/30 text-red-500 hover:bg-red-500/10 transition-all flex items-center justify-center gap-2" do %>
            <span class="material-symbols-outlined">delete</span>
            Delete Task
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
